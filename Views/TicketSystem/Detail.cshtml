@model PlusCP.Models.TicketSystem
@{
    ViewBag.Title = "Detail";
    Layout = "~/Views/Shared/_LayoutEmpty.cshtml";
}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<style>
    body {
        background: #f2f4f7;
        font-family: 'Inter', 'Segoe UI', sans-serif;
        color: #333;
    }

    .ticket-container {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin: auto;
    }

    .ticket-main, .ticket-sidebar {
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        padding: 30px;
        transition: all 0.3s ease;
    }

    .ticket-main {
        flex: 2 1 700px;
    }

    .ticket-sidebar {
        flex: 1 1 350px;
        height: fit-content;
    }

        .ticket-main:hover, .ticket-sidebar:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

    .ticket-header h1 {
        color: #003B59;
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
    }

        .ticket-header h1 i {
            margin-right: 10px;
        }

    .ticket-created {
        font-size: 15px;
        color: #555;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
    }

        .ticket-created i {
            color: #003B59;
            margin-right: 6px;
        }

    .section-title {
        font-weight: 600;
        color: #3949ab;
        margin-bottom: 15px;
        border-left: 5px solid #5c6bc0;
        padding-left: 12px;
        font-size: 17px;
    }

    .desc-box {
        background: #f4f6fb;
        border: 1px solid #e0e3f0;
        border-radius: 10px;
        padding: 18px 20px;
        color: #333;
        font-size: 15px;
        line-height: 1.6;
        white-space: pre-wrap;
    }

    .progress {
        width: 80%;
        height: 18px;
        border-radius: 12px;
        overflow: hidden;
        background-color: #e9e9f4;
        margin: 0 auto;
    }

    .progress-bar {
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }



    .field-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #e6e9f8;
        font-size: 15px;
    }

        .field-row:last-child {
            border-bottom: none;
        }

    .field-label {
        font-weight: 600;
        color: #5c6bc0;
    }

    .field-value {
        font-weight: 500;
        color: #1a237e;
        text-align: right;
        word-break: break-word;
    }

    .badge {
        padding: 5px 12px;
        font-size: 13px;
        border-radius: 12px;
    }




    @@media (max-width: 1200px) {
        .ticket-container {
            padding: 30px 25px;
        }
    }

    @@media (max-width: 992px) {
        .ticket-container {
            flex-direction: column;
        }

        .field-row {
            flex-direction: column;
            align-items: flex-start;
        }

        .field-value {
            text-align: left;
            width: 100%;
            margin-top: 4px;
        }
    }




    .modal-body {
        max-height: 80vh;
        overflow-y: hidden;
        padding: 2rem 3rem;
    }


    .modal-header {
        background-color: #D6EFE8;
        color: #003B59
    }

        .modal-header .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }


    .mb-3 {
        margin-bottom: 1.25rem !important;
    }



    #ticketForm .form-control,
    #ticketForm .form-select {
        border-radius: 6px;
        box-shadow: none;
    }



    .row.g-4 {
        margin-left: 0;
        margin-right: 0;
        gap: 2rem;
    }


    .card.h-100 {
        padding: 2rem 2.5rem !important;
    }


    .col-md-6 {
        flex: 1;
    }


    .mb-3 {
        margin-bottom: 1.2rem !important;
    }


    .form-select {
        border-radius: 50px !important;
        border: 1px solid #00b4d8 !important;
        padding: 4px 9px !important;
        color: #003b59;
        background-color: #ffffff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease-in-out;
    }


        .form-select:hover {
            box-shadow: 0 3px 8px rgba(0, 180, 216, 0.2);
        }

        .form-select:focus {
            border-color: #007bff !important;
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
            outline: none;
        }

    #ticketForm .form-control,
    #ticketForm .form-select {
        border-radius: 6px;
        box-shadow: none;
    }


    .btnUpdate {
        background-color: #003B59; /* Default background color */
        border-color: #003B59; /* Default border color */
        color: #fff; /* Default text color */
    }

        .btnUpdate:hover {
            background-color: transparent; /* Make background transparent on hover */
            border-color: #003B59; /* Dark border color on hover */
            color: #003B59; /* Dark font color on hover */
        }


    .btnClose {
        background-color: whitesmoke; /* Make background transparent on hover */
        color: #003B59; /* Dark font color on hover */
        transform: scale(1.05); /* Slightly scale up the card on hover */
    }

        .btnClose:hover {
            border: 1px solid #003B59; /* Thicker border with dark color on hover */
            color: #003B59; /* Dark font color on hover */
            transform: scale(1.05); /* Slightly scale up the card on hover */
            -webkit-box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* More pronounced shadow on hover */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* More pronounced shadow on hover */
        }



    /* Wrapper */
    .comment-wrapper {
        margin: 15px auto;
        background: #fff;
        border: 1px solid #e3e6ea;
        border-radius: 10px;
        padding: 10px 10px;
    }

    /* Title */
    .comments-title {
        font-size: 18px;
        font-weight: 600;
        color: #222;
        border-bottom: 2px solid #e8ecef;
        padding-bottom: 8px;
        margin-bottom: 20px;
    }

    /* Comments List */
    .comments-list {
       
        overflow-y: hidden;
        padding-right: 8px;
    }

    /* Single Comment */
    .comment-item {
        background: #f9fafb;
        border: 1px solid #e4e7eb;
        border-radius: 8px;
        padding: 12px 14px;
        margin-bottom: 12px;
        transition: all 0.2s ease-in-out;
    }

        .comment-item:hover {
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

    .comment-header {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        color: #666;
    }

    .comment-user {
        font-weight: 600;
        color: #1f2937;
    }

    .comment-text {
        margin-top: 6px;
        font-size: 14px;
        color: #333;
        line-height: 1.5;
    }

    
    .comment-box {
        display: flex;
        align-items: flex-start;
        margin-top: 20px;
        gap: 10px;
    }

        .comment-box textarea {
            flex: 1;
            height: 70px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
            resize: none;
            outline: none;
            transition: border 0.2s;
        }

            .comment-box textarea:focus {
                border-color: #2563eb;
            }

        .comment-box button {
            background-color: #2563eb;
            border: none;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

            .comment-box button:hover {
                background-color: #1e4ed8;
            }
</style>

<div class="container-fluid mt-4 mb-5">
    <div class="ticket-container">
        <!-- LEFT SIDE -->
        <div class="ticket-main">
            <div class="ticket-header d-flex justify-content-between align-items-center">
                <button class="btn btn-link text-secondary text-decoration-none btn-lg pull-right d-flex align-items-center gap-2"
                        id="btnEditTicket" data-id="@Model.ticket_id" style="font-size:16px;">
                    <i class="fa fa-pencil-alt" style="font-size:18px;"></i>
                    <span>Edit</span>
                </button>


                <h1><i class="fa fa-ticket-alt"></i> #@Model.ticket_id - @Model.title</h1>


            </div>


            <p class="ticket-created">
                <i class="fa fa-clock"></i>
                Created @Model.createdDays day(s) ago, Updated @Model.updatedDays day(s) ago
            </p>

            <div class="mb-4">
                <h5 class="section-title">Description</h5>
                <div class="desc-box">@Html.Raw(Model.description)</div>
            </div>


            <div class="mb-4">
                <h5 class="section-title">Notes</h5>
                <div class="desc-box">@Html.DisplayFor(m => m.notes)</div>
            </div>


        </div>

        <!-- RIGHT SIDE -->
        <div class="ticket-sidebar">
            <h5 class="section-title mb-3">Ticket Info</h5>

            <div class="field-row">
                <div class="field-label">Status</div>
                <div class="field-value"><span class="badge bg-info">@Model.status</span></div>
            </div>

            <div class="field-row">
                <div class="field-label">Progress</div>
                <div class="field-value" style="width:100%">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             style="width:@Model.progress%; background-color:#28a745;"
                             role="progressbar" aria-valuenow="@Model.progress" aria-valuemin="0" aria-valuemax="100">
                            @Model.progress%
                        </div>

                    </div>
                </div>
            </div>

            <div class="field-row">
                <div class="field-label">Priority</div>
                <div class="field-value"><span class="badge bg-danger">@Model.priority</span></div>
            </div>

            <div class="field-row">
                <div class="field-label">Type</div>
                <div class="field-value">@Model.ticket_type</div>
            </div>

            <div class="field-row">
                <div class="field-label">Created By</div>
                <div class="field-value">@Model.created_by</div>
            </div>

            <div class="field-row">
                <div class="field-label">Assigned To</div>
                <div class="field-value">@Model.assigned_to</div>
            </div>

            <div class="field-row">
                <div class="field-label">ETA</div>
                <div class="field-value">@Model.eta</div>
            </div>

            <div class="field-row">
                <div class="field-label">Created At</div>
                <div class="field-value">@Model.created_at</div>
            </div>
        </div>
    </div>
</div>

<div class="comment-wrapper">
    <h5 class="comments-title"><i class="fas fa-comments"></i> Discussion</h5>

   
    <div id="commentsSection" class="comments-list">
        <p class="text-muted">Loading comments...</p>
    </div>

   
    <div class="comment-box">
        <textarea id="newComment" placeholder="Write a comment..."></textarea>
        <button id="btnAddComment"><i class="fas fa-paper-plane"></i> Post</button>
    </div>
</div>



<div class="modal fade" id="editTicketModal" tabindex="-1" aria-labelledby="editTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">

           
            <div class="modal-header">
                <h4 class="modal-title fw-bold">
                    <i class="fas fa-edit me-2"></i> Edit Ticket
                </h4>
                <button type="button" class="close full-opacity-hover" data-dismiss="modal">&times;</button>
            </div>

           
            <div class="modal-body bg-light" style="font-size: 14px; padding: 10px;">
                <form id="editTicketForm">
                    <input type="hidden" id="ticket_id" />

                    <div class="card shadow-sm" style="max-width: 600px; margin: 0 auto; padding: 10px; border-radius: 10px;">

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-semibold small">Tracker <span class="text-danger">*</span></label>
                                <select id="edit_ticket_type" class="form-select form-select-sm">
                                    <option value="">Select Type</option>
                                    <option value="Bug">Bug</option>
                                    <option value="Feature">Feature</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-semibold small">Status <span class="text-danger">*</span></label>
                                <select id="edit_status" class="form-select form-select-sm">
                                    <!-- hidden New option for binding -->
                                    <option value="New" style="display:none;">New</option>

                                    @if (ViewBag.FirstName == "Super")
                                    {
                                        <option value="In Progress">In Progress</option>
                                        <option value="Resolved">Resolved</option>
                                        <option value="Closed">Closed</option>
                                    }
                                    else
                                    {
                                        <option value="Reopen">Reopen</option>
                                        <option value="Closed">Closed</option>
                                    }

                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-semibold small">Priority <span class="text-danger">*</span></label>
                                <select id="edit_priority" class="form-select form-select-sm">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                    <option value="Critical">Critical</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold small">Title <span class="text-danger">*</span></label>
                            <input type="text" id="edit_title" class="form-control form-control-sm" placeholder="Enter ticket title" />
                        </div>

                        <div class="mb-3">
                            <div class="api-settings-card shadow-lg p-4 rounded w-100" style="max-width: 900px; margin:auto;">
                                <label class="form-label fw-semibold small">
                                    Description <span class="text-danger">*</span>
                                </label>
                                <textarea class="form-control" id="edit_description" rows="4"></textarea>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-semibold small">% Done</label>
                                <select id="edit_progress_percentage" class="form-select form-select-sm">
                                    @for (int i = 0; i <= 100; i += 10)
                                    {
                                        <option value="@i">@i%</option>
                                    }
                                </select>
                            </div>

                            

                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-semibold small">Requested Due Date <span class="text-danger">*</span></label>
                                <input type="date" id="edit_eta" class="form-control form-control-sm" />
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label fw-semibold small">Additional Notes</label>
                                <textarea id="edit_notes" class="form-control form-control-sm" rows="2" placeholder="Optional notes or comments"></textarea>
                            </div>
                        </div>

                    </div>
                </form>
            </div>


            <div class="modal-footer">
                <button type="button" class="btnClose" data-dismiss="modal">
                    Cancel
                </button>
                <button type="button" id="btnUpdateTicket" class="btnUpdate">
                    Update
                </button>
            </div>

        </div>
    </div>
</div>

<script>
$(document).ready(function () {
    const firstName = '@ViewBag.FirstName';

    const userType = '@ViewBag.UserType';
    const ticketId = '@Model.ticket_id';

    
    if (ticketId) LoadComments(ticketId);

    
    function DescriptionFormatting() {
        const $el = $('#edit_description');
        if ($el.length && !$el.next('.note-editor').length) {
            $el.summernote({
                placeholder: 'Write description...',
                height: 100,
                toolbar: [
                    ['style', ['bold', 'italic', 'underline', 'clear']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['font', ['strikethrough', 'superscript', 'subscript']],
                    ['insert', ['link']],
                    ['view', ['undo', 'redo']]
                ]
            });
        }
    }


    $(document).on("click", "#btnEditTicket", function () {
        debugger;
        const ticketId = $(this).data("id");
        console.log("Fetching ticket ID:", ticketId);

        if (firstName !== "Super") {
            $('#edit_eta').closest('.col-md-4').hide();
            $('#edit_progress_percentage').closest('.col-md-4').hide();
        } else {
            $('#edit_eta').closest('.col-md-4').show();
            $('#edit_progress_percentage').closest('.col-md-4').show();
        }

        $.ajax({
            url: '/TicketSystem/GetTicketById',
            type: 'GET',
            data: { ticketId },
            success: function (response) {
                if (!response.success) return alert("Ticket not found!");

                // Basic fields
                $("#ticket_id").val(response.ticket_id);
                $("#edit_title").val(response.title);

                DescriptionFormatting();
                $('#edit_description').summernote('code', response.description || '');

                $("#edit_ticket_type").val(response.ticket_type);
                $("#edit_priority").val(response.priority);
                $("#edit_eta").val(response.eta ? response.eta.split('T')[0] : '');
                $("#edit_progress_percentage").val(response.progress);
                $("#edit_notes").val(response.notes);

                // ✅ STATUS HANDLING
                const statusDropdown = $("#edit_status");
                const currentStatus = response.status?.trim() || '';

                // Check if the dropdown already has this option
                if (currentStatus && statusDropdown.find(`option[value='${currentStatus}']`).length === 0) {
                    // Add temporary option (e.g. "New")
                    statusDropdown.prepend(
                        $('<option>', { value: currentStatus, text: currentStatus })
                    );
                }

                // Select the current status
                statusDropdown.val(currentStatus);

                // ✅ Progress visibility logic
                if (firstName !== "Super") {
                    $('#edit_progress_percentage').closest('.col-md-4').hide();
                    $('#edit_progress_percentage').val(0);
                } else {
                    $('#edit_progress_percentage').closest('.col-md-4').show();
                }

                $("#editTicketModal").modal("show");
            },
            error: function (xhr, status, error) {
                console.error("Error fetching ticket:", error);
                alert("Error fetching ticket details.");
            }
        });
    });


    
    $(document).on("click", "#btnUpdateTicket", function () {
        debugger;

        DescriptionFormatting();

        const ticketData = {
            ticket_id: $('#ticket_id').val(),
            title: $('#edit_title').val().trim(),
            description: encodeURIComponent($('#edit_description').summernote('code')),
            ticket_type: $('#edit_ticket_type').val(),
            status: $('#edit_status').val(),
            priority: $('#edit_priority').val(), 
            eta: (firstName === "Super") ? $('#edit_eta').val() : null,
            progress_percentage: (firstName === "Super") ? parseInt($('#edit_progress_percentage').val() || 0) : 0,
            notes: $('#edit_notes').val().trim()
        };


        if (firstName !== "Super") {
           
            if (!ticketData.ticket_type || !ticketData.title || !ticketData.description ||
                !ticketData.status || !ticketData.priority) {
                MsgToast('Please fill all required fields before saving.', 'Validation Error', 'warning');
                return;
            }
        }
            else {
                     
        if (!ticketData.ticket_type || !ticketData.title || !ticketData.description ||
            !ticketData.status || !ticketData.priority || !ticketData.eta) {
            MsgToast('Please fill all required fields before saving.', 'Validation Error', 'warning');
            return;
        }
            }
        
       

        $.ajax({
            url: '/TicketSystem/UpdateTicket',
            type: 'POST',
            data: ticketData,
            success: function (data) {
                if (data.success) {
                    MsgToast(data.message || 'Ticket updated successfully.', 'Success', 'success');
                    $('#editTicketModal').modal('hide');

                    setTimeout(() => {
                        window.location.href = '/TicketSystem/Detail?ticketId=' + ticketData.ticket_id + '&page=list';
                    }, 2700);
                } else {
                    MsgToast(data.message || 'Failed to update ticket.', 'Error', 'error');
                }
            },
            error: function (xhr) {
                console.error(xhr.responseText);
                MsgToast('Something went wrong while saving the ticket.', 'Error', 'error');
            }
        });
    });

    
    function LoadComments(ticketId) {
        $.ajax({
            url: '/TicketSystem/GetComments',
            type: 'GET',
            data: { ticketId },
            success: function (res) {
                const comments = res.comments || res;
                if (comments.length > 0) {
                    let html = comments.map(c => `
                        <div class="comment-item mb-2 p-2 bg-white rounded shadow-sm">
                            <div class="d-flex justify-content-between">
                                <span class="fw-semibold text-primary" style=font-size:16px; font-weight:bold;><i class="fas fa-user-circle me-1" style=padding:2px; ></i>${c.UserName}</span>
                                <small class="text-muted">${c.CreatedAt}</small>
                            </div>
                            <div class="mt-1 text-dark">${c.CommentText}</div>
                        </div>
                    `).join('');
                    $('#commentsSection').html(html);
                } else {
                    $('#commentsSection').html('<p class="text-muted">No comments yet.</p>');
                }
            },
            error: function () {
                $('#commentsSection').html('<p class="text-danger">Failed to load comments.</p>');
            }
        });
    }

    
    $(document).on('click', '#btnAddComment', function () {
        debugger;
        const comment = $('#newComment').val().trim();
        if (comment === '') {
            MsgToast('Please write a comment before posting.', 'Validation', 'warning');
            return;
        }

        $.ajax({
            url: '/TicketSystem/InsertComment',
            type: 'POST',
            data: { ticketId, commentText: comment },
            success: function (res) {
                if (res.success) {
                    MsgToast('Comment added successfully!', 'Success', 'success');
                    $('#newComment').val('');
                    LoadComments(ticketId);
                } else {
                    MsgToast(res.message || 'Failed to add comment.', 'Error', 'error');
                }
            },
            error: function () {
                MsgToast('Error adding comment.', 'Error', 'error');
            }
        });
    });
});
</script>


