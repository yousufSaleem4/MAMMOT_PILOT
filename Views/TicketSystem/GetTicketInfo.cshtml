@model PlusCP.Models.TicketSystem
@{
    ViewBag.Title = "GetTicketInfo";
    Layout = cCommon.SwitchToDetailPage(Request.Url.PathAndQuery);
}

<style>
    body {
        background: linear-gradient(120deg, #eef2f7 0%, #f7f9fc 100%);
        font-family: "Segoe UI", "Roboto", sans-serif;
        margin: 0;
        padding: 0;
    }

    .ticket-container {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        padding: 40px 50px;
        max-width: 1400px;
        margin: auto;
    }

    .ticket-main, .ticket-sidebar {
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        padding: 30px 35px;
        transition: all 0.3s ease;
    }

    .ticket-main {
        flex: 2 1 700px;
    }

    .ticket-sidebar {
        flex: 1 1 350px;
        height: fit-content;
    }

        .ticket-main:hover, .ticket-sidebar:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

    .ticket-header h1 {
        color: #003B59;
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
    }

        .ticket-header h1 i {
            margin-right: 10px;
        }

    .ticket-created {
        font-size: 15px;
        color: #555;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
    }

        .ticket-created i {
            color: #003B59;
            margin-right: 6px;
        }

    .section-title {
        font-weight: 600;
        color: #3949ab;
        margin-bottom: 15px;
        border-left: 5px solid #5c6bc0;
        padding-left: 12px;
        font-size: 17px;
    }

    .desc-box {
        background: #f4f6fb;
        border: 1px solid #e0e3f0;
        border-radius: 10px;
        padding: 18px 20px;
        color: #333;
        font-size: 15px;
        line-height: 1.6;
        white-space: pre-wrap;
    }

    .progress {
        width: 80%; /* full width ki jagah 80% kar diya */
        height: 18px; /* chhoti height */
        border-radius: 12px;
        overflow: hidden;
        background-color: #e9e9f4;
        margin: 0 auto; /* center align karne ke liye */
    }

    .progress-bar {
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }



    .field-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #e6e9f8;
        font-size: 15px;
    }

        .field-row:last-child {
            border-bottom: none;
        }

    .field-label {
        font-weight: 600;
        color: #5c6bc0;
    }

    .field-value {
        font-weight: 500;
        color: #1a237e;
        text-align: right;
        word-break: break-word;
    }

    .badge {
        padding: 5px 12px;
        font-size: 13px;
        border-radius: 12px;
    }

    #commentsSection {
        background: #f7f9ff;
        border: 1px solid #e0e4ff;
        border-radius: 10px;
        padding: 18px;
        max-height: 400px;
        overflow-y: auto;
    }

    .comment-box {
        border-left: 4px solid #5c6bc0;
        background: #fff;
        padding: 12px 18px;
        margin-bottom: 12px;
        border-radius: 8px;
        font-size: 14px;
        color: #333;
    }

    #toastMessage {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        font-weight: 500;
        padding: 12px 18px;
        color: #fff;
        position: fixed;
        top: 15px;
        right: 15px;
        z-index: 9999;
        display: none;
    }

    @@media (max-width: 1200px) {
        .ticket-container {
            padding: 30px 25px;
        }
    }

    @@media (max-width: 992px) {
        .ticket-container {
            flex-direction: column;
        }

        .field-row {
            flex-direction: column;
            align-items: flex-start;
        }

        .field-value {
            text-align: left;
            width: 100%;
            margin-top: 4px;
        }
    }



    /* XXL Modal Width */
    .modal-xxl {
        max-width: 95%;
        width: 95%;
    }

    /* Scroll + Padding */
    .modal-body {
        max-height: 80vh;
        overflow-y: auto;
        /*padding: 1rem 2rem;*/
    }

    .modal-header,
    .modal-footer {
        padding: 1rem 2rem;
    }


    /* Gradient Header */
    .modal-header {
        background: #003B59;
        color: white;
        border-bottom: none;
    }

        .modal-header .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: white;
        }

    .modal-footer {
        background: #f8f9fa;
        border-top: none;
    }

    /* Add spacing between form fields */
    .mb-3 {
        margin-bottom: 1.25rem !important;
    }

    .modal-header .close {
        position: absolute;
        top: 1rem;
        right: 1rem;
    }


    /* Space between left & right columns */
    .row.g-4 {
        margin-left: 0;
        margin-right: 0;
        gap: 2rem; /* 👈 ye main line spacing create karegi */
    }

    /* Add consistent padding inside each column card */
    .card.h-100 {
        padding: 2rem 2.5rem !important;
    }

    /* Slightly separate the right side column visually */
    .col-md-6 {
        flex: 1;
    }

    /* Increase bottom margin between fields */
    .mb-3 {
        margin-bottom: 1.5rem !important;
    }

    /* 🔹 Rounded dropdowns (pill style) */
    .form-select {
        border-radius: 50px !important;
        border: 1px solid #00b4d8 !important;
        padding: 8px 18px !important;
        font-weight: 500;
        color: #003b59;
        background-color: #ffffff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease-in-out;
    }

        /* Hover + focus effects */
        .form-select:hover {
            box-shadow: 0 3px 8px rgba(0, 180, 216, 0.2);
        }

        .form-select:focus {
            border-color: #007bff !important;
            box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
            outline: none;
        }
</style>

<div class="container-fluid mt-4 mb-5">
    <div class="ticket-container">
        <!-- LEFT SIDE 
        <div class="ticket-main">
            <div class="ticket-header d-flex justify-content-between align-items-center">
                <button class="btn btn-link text-secondary text-decoration-none btn-lg pull-right d-flex align-items-center gap-2"
                        id="btnEditTicket" data-id="@Model.ticket_id" style="font-size:16px;">
                    <i class="fa fa-pencil-alt" style="font-size:18px;"></i>
                    <span>Edit</span>
                </button>


                <h1><i class="fa fa-ticket-alt"></i> #@Model.ticket_id - @Model.title</h1>


            </div>


            <p class="ticket-created">
                <i class="fa fa-clock"></i>
                Created @Model.createdDays day(s) ago, Updated @Model.updatedDays day(s) ago
            </p>

            <div class="mb-4">
                <h5 class="section-title">Description</h5>
                <div class="desc-box">@Html.DisplayFor(m => m.description)</div>
            </div>

            <div class="mb-4">
                <h5 class="section-title">Notes</h5>
                <div class="desc-box">@Html.DisplayFor(m => m.notes)</div>
            </div>


        </div>

         RIGHT SIDE 
        <div class="ticket-sidebar">
            <h5 class="section-title mb-3">Ticket Info</h5>

            <div class="field-row">
                <div class="field-label">Status</div>
                <div class="field-value"><span class="badge bg-info">@Model.status</span></div>
            </div>

            <div class="field-row">
                <div class="field-label">Progress</div>
                <div class="field-value" style="width:100%">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             style="width:@Model.progress%;"
                             role="progressbar" aria-valuenow="@Model.progress" aria-valuemin="0" aria-valuemax="100">
                            @Model.progress%
                        </div>
                    </div>
                </div>
            </div>

            <div class="field-row">
                <div class="field-label">Priority</div>
                <div class="field-value"><span class="badge bg-danger">@Model.priority</span></div>
            </div>

            <div class="field-row">
                <div class="field-label">Type</div>
                <div class="field-value">@Model.ticket_type</div>
            </div>

            <div class="field-row">
                <div class="field-label">Created By</div>
                <div class="field-value">@Model.created_by</div>
            </div>

            <div class="field-row">
                <div class="field-label">Assigned To</div>
                <div class="field-value">@Model.assigned_to</div>
            </div>

            <div class="field-row">
                <div class="field-label">ETA</div>
                <div class="field-value">@Model.eta</div>
            </div>

            <div class="field-row">
                <div class="field-label">Created At</div>
                <div class="field-value">@Model.created_at</div>
            </div>
        </div>
    </div>
</div>

 ✅ EDIT TICKET MODAL 
<div class="modal fade" id="editTicketModal" tabindex="-1" aria-labelledby="editTicketModalLabel">
    <div class="modal-dialog modal-xxl modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">

             Header 
            <div class="modal-header py-3 px-4">
                <h4 class="modal-title fw-bold">
                    <i class="fas fa-edit me-2"></i> Edit Ticket
                </h4>
                <button type="button" class="close full-opacity-hover" data-dismiss="modal">&times;</button>
            </div>

             Body 
            <div class="modal-body bg-light px-5 py-4">
                <form id="editTicketForm">
                    <input type="hidden" id="ticket_id" />

                    <div class="row g-4">
                         Left Column 
                        <div class="col-md-6">
                            <div class="card h-100 p-4 shadow-sm border-0">
                                <h5 class="text-primary fw-bold mb-3">
                                    <i class="fas fa-info-circle me-2"></i>Ticket Information
                                </h5>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Tracker</label>
                                    <select id="edit_ticket_type" class="form-select shadow-sm">
                                        <option value="">Select Type</option>
                                        <option value="Bug">Bug</option>
                                        <option value="Feature">Feature</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Title</label>
                                    <input type="text" id="edit_title" class="form-control shadow-sm" placeholder="Enter ticket title" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Description</label>
                                    <textarea id="edit_description" class="form-control shadow-sm" rows="8" placeholder="Describe the issue..."></textarea>
                                </div>
                            </div>
                        </div>

                         Right Column 
                        <div class="col-md-6">
                            <div class="card h-100 p-4 shadow-sm border-0">
                                <h5 class="text-primary fw-bold mb-3">
                                    <i class="fas fa-cogs me-2"></i>Ticket Details
                                </h5>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Status</label>
                                    <select id="edit_status" class="form-select shadow-sm">
                                        <option value="Open">Open</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Resolved">Resolved</option>
                                        <option value="Closed">Closed</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Priority</label>
                                    <select id="edit_priority" class="form-select shadow-sm">
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                        <option value="Critical">Critical</option>
                                    </select>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-semibold">ETA (Due Date)</label>
                                        <input type="date" id="edit_eta" class="form-control shadow-sm" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">% Done</label>
                                    <select id="edit_progress_percentage" class="form-select shadow-sm">
                                        @for (int i = 0; i <= 100; i += 10)
                                        {
                                            <option value="@i">@i%</option>
                                        }
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Additional Notes</label>
                                    <textarea id="edit_notes" class="form-control shadow-sm" rows="3" placeholder="Optional notes or comments"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

             Footer 
            <div class="modal-footer bg-light py-3 px-5 border-top-0">
                <button type="button" class="btn btn-outline-secondary px-4" data-dismiss="modal">
                    Cancel
                </button>
                <button type="button" id="btnUpdateTicket" class="btn btn-primary px-4">
                        <i class="fas fa-save me-2"></i>Update Ticket
                    </button>
                <button type="button" id="btnUpdateTicket" class="btn btn-primary px-4">Update</button>


            </div>
        </div>
    </div>
</div>-->
 Toast Container 
<div id="toastMessage" style="display:none; position:fixed; top:10px; right:10px; padding:10px; color:white; z-index:9999;"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>


    $(document).ready(function () {
        // ✅ Edit button click - fetch ticket details
        $(document).on("click", "#btnEditTicket", function () {
            debugger
            var ticketId = $(this).data("id");
            console.log("Fetching ticket ID:", ticketId);

            $.ajax({
                url: '/TicketSystem/GetTicketById',
                type: 'GET',
                data: { ticketId: ticketId },
                success: function (response) {
                    if (response.success) {
                        $("#ticket_id").val(response.ticket_id);
                        $("#edit_title").val(response.title);
                        $("#edit_description").val(response.description);
                        $("#edit_ticket_type").val(response.ticket_type);
                        $("#edit_status").val(response.status);
                        $("#edit_priority").val(response.priority);
                        $("#edit_eta").val(response.eta ? response.eta.split('T')[0] : '');
                        $("#edit_progress_percentage").val(response.progress);
                        $("#edit_notes").val(response.notes);

                        $("#editTicketModal").modal("show");
                    } else {
                        alert("Ticket not found!");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching ticket:", error);
                    alert("Error fetching ticket details.");
                }
            });
        });

        $(document).on("click", "#btnUpdateTicket", function () {
            debugger
            console.log("hello");
            var ticketData = {
                ticket_id: $('#ticket_id').val(),
                title: $('#edit_title').val(),
                description: $('#edit_description').val(),
                ticket_type: $('#edit_ticket_type').val(),
                status: $('#edit_status').val(),
                priority: $('#edit_priority').val(),
                assigned_to: parseInt($('#edit_assigned_to').val()),
                eta: $('#edit_eta').val(),
                progress_percentage: parseInt($('#edit_progress_percentage').val()),
                notes: $('#edit_notes').val()
            };

            $.ajax({
                url: '/TicketSystem/UpdateTicket',
                type: 'POST',
                data: ticketData, // notice: JSON.stringify nahi
                success: function (response) {
                    alert(response.message);
                },
                error: function (xhr) {
                    alert('Error: ' + xhr.responseText);
                }
            });


        });


        // ✅ Toast function
        //function showToast(message, type = 'success') {
        //    var toast = $('#toastMessage');
        //    if (toast.length === 0) {
        //        // agar toast div missing ho, dynamically bana do
        //        $('body').append('<div id="toastMessage" style="position:fixed;top:20px;right:20px;padding:12px 20px;color:white;border-radius:6px;z-index:9999;display:none;"></div>');
        //        toast = $('#toastMessage');
        //    }

        //    toast.text(message);
        //    toast.css({
        //        'background-color': type === 'success' ? 'green' : 'red',
        //        'font-weight': '500',
        //        'box-shadow': '0 2px 6px rgba(0,0,0,0.3)'
        //    });

        //    toast.fadeIn(300).delay(2500).fadeOut(400);
        //}

    });
</script>



